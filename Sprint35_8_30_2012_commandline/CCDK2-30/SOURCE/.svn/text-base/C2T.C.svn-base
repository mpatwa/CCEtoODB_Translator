/* -2 -3 */
/********************************** C2T.C **********************************/
/***************************** 2d transforms *******************************/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
#include <aladefs.h>
#include <alldefs.h>
#include <c2tdefs.h>
#include <c2tpriv.h>
#include <c2vdefs.h>
#include <c2vmcrs.h>
STATIC REAL*   c2t_mult0 __(( C2_TRANSFORM DUMMY0 , C2_TRANSFORM DUMMY1 ,
            C2_TRANSFORM DUMMY2 )) ;
STATIC REAL*   c2t_mult1 __(( C2_TRANSFORM DUMMY0 , C2_TRANSFORM DUMMY1 )) ;
STATIC REAL*   c2t_mult2 __(( C2_TRANSFORM DUMMY0 , C2_TRANSFORM DUMMY1 )) ;

/*-------------------------------------------------------------------------*/
BBS_PUBLIC C2_TRANSFORM *c2t_create ( ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
{
    REAL *t ;
    t = MALLOC ( 6, REAL ) ;
    t[0] = t[4] = 1.0 ;
    t[1] = t[2] = t[3] = t[5] = 0.0 ;
    RETURN ( (C2_TRANSFORM*)t ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL* c2t_init ( t ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C2_TRANSFORM t ;
{
    t[0][0] = t[1][1] = 1.0 ;
    t[0][1] = t[0][2] = t[1][0] = t[1][2] = 0.0 ;
    RETURN ( (REAL*)t ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC void c2t_free ( t ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C2_TRANSFORM t ;
{
    FREE ( t ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL* c2t_eval_pt ( a, t, b ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT2 a ;
C2_TRANSFORM t ;
PT2 b ;
{
    PT2 c ;
    c[0] = a[0] * t[0][0] + a[1] * t[0][1] + t[0][2] ;
    c[1] = a[0] * t[1][0] + a[1] * t[1][1] + t[1][2] ;
    b[0] = c[0] ;
    b[1] = c[1] ;
    RETURN ( b ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL* c2t_copy ( t1, t2 ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C2_TRANSFORM t1, t2 ;
{
    ala_copy ( (REAL*)t1, 6, (REAL*)t2 ) ;
    RETURN ( (REAL*)t2 ) ;
}


#ifdef SPLINE
/*-------------------------------------------------------------------------*/
BBS_PRIVATE REAL* c2t_eval_hpt ( a, t, b ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
HPT2 a ;
C2_TRANSFORM t ;
HPT2 b ;
{
    PT2 c ;
    c[0] = a[0] * t[0][0] + a[1] * t[0][1] + a[2] * t[0][2] ;
    c[1] = a[0] * t[1][0] + a[1] * t[1][1] + a[2] * t[1][2] ;
    b[0] = c[0] ;
    b[1] = c[1] ;
    b[2] = a[2] ;
    RETURN ( b ) ;
}
#endif /*SPLINE*/

/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL* c2t_eval_vec ( a, t, b ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT2 a ;
C2_TRANSFORM t ;
PT2 b ;
{
    PT2 c ;

    c[0] = a[0] * t[0][0] + a[1] * t[0][1] ;
    c[1] = a[0] * t[1][0] + a[1] * t[1][1] ;
    b[0] = c[0] ;
    b[1] = c[1] ;
    RETURN ( b ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC BOOLEAN c2t_orthogonal ( t ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C2_TRANSFORM t ;
{
    REAL p0, p1, tol ;

    p0 = t[0][0] * t[0][0] + t[1][0] * t[1][0] ;
    p1 = t[0][1] * t[0][1] + t[1][1] * t[1][1] ;
    tol = BBS_ZERO * ( p0 + p1 ) ;

    RETURN ( ( fabs ( p0 - p1 ) <= tol ) && 
        ( fabs ( t[0][0] * t[0][1] + t[1][0] * t[1][1] ) <= tol ) ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC BOOLEAN c2t_positive ( t ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C2_TRANSFORM t ;
{
    RETURN ( c2t_det ( t ) > 0.0 ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL* c2t_mult ( t1, t2, t ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C2_TRANSFORM t1, t2, t ;        /* t = t2 * t1 */
{
    if ( t == t1 ) 
        RETURN ( c2t_mult1 ( t1, t2 ) ) ;
    else if ( t == t2 ) 
        RETURN ( c2t_mult2 ( t1, t2 ) ) ;
    else 
        RETURN ( c2t_mult0 ( t1, t2, t ) ) ;
}


/*-------------------------------------------------------------------------*/
STATIC REAL* c2t_mult0 ( t1, t2, t ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C2_TRANSFORM t1, t2, t ;        /* t = t2 * t1 */
{
    INT i ;

    for ( i=0 ; i<2 ; i++ ) {
        t[i][0] = t2[i][0]*t1[0][0] + t2[i][1]*t1[1][0] ;
        t[i][1] = t2[i][0]*t1[0][1] + t2[i][1]*t1[1][1] ;
        t[i][2] = t2[i][0]*t1[0][2] + t2[i][1]*t1[1][2] + t2[i][2] ;
    }
    RETURN ( (REAL*)t ) ;
}


/*-------------------------------------------------------------------------*/
STATIC REAL* c2t_mult1 ( t1, t2 ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C2_TRANSFORM t1, t2 ;        /* t1 = t2 * t1 */
{
    C2_TRANSFORM t ;

    c2t_mult0 ( t1, t2, t ) ;
    c2t_copy ( t, t1 ) ;
    RETURN ( (REAL*)t1 ) ;
}


/*-------------------------------------------------------------------------*/
STATIC REAL* c2t_mult2 ( t1, t2 ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C2_TRANSFORM t1, t2 ;        /* t1 = t2 * t1 */
{
    C2_TRANSFORM t ;

    c2t_mult0 ( t1, t2, t ) ;
    c2t_copy ( t, t2 ) ;
    RETURN ( (REAL*)t1 ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL* c2t_translate ( shift, t ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT2 shift ;
C2_TRANSFORM t ; 
{
    t[0][0] = t[1][1] = 1.0 ;
    t[1][0] = t[0][1] = 0.0 ;
    t[0][2] = shift[0] ;
    t[1][2] = shift[1] ;
    RETURN ( (REAL*)t ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL* c2t_rotate ( origin, angle, t ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT2 origin ;
REAL angle ;
C2_TRANSFORM t ; 
{
    REAL c, s ;

    c = cos ( angle ) ;
    s = sin ( angle ) ;
    RETURN ( c2t_rotate_cs ( origin, c, s, t ) ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL* c2t_rotate_cs ( origin, c, s, t ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT2 origin ;
REAL c, s ;
C2_TRANSFORM t ; 
{
    t[0][0] = t[1][1] = c ;
    t[1][0] = s ;
    t[0][1] = - s ;
    t[0][2] = - c * origin[0] + s * origin[1] + origin[0] ;
    t[1][2] = - s * origin[0] - c * origin[1] + origin[1] ;
    RETURN ( (REAL*)t ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL* c2t_scale ( origin, f0, f1, t ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT2 origin ;
REAL f0, f1 ;
C2_TRANSFORM t ; 
{
    t[0][0] = f0 ;
    t[1][1] = f1 ;
    t[0][1] = t[1][0] = 0.0 ;
    t[0][2] = origin[0] * ( 1.0 - f0 ) ;
    t[1][2] = origin[1] * ( 1.0 - f1 ) ;
    RETURN ( (REAL*)t ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL* c2t_mirror_line ( line, t ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT2 line[2] ;
C2_TRANSFORM t ; 
{
    PT2 origin, direction ;

    C2V_COPY ( line[0], origin ) ;
    direction[0] = line[1][1] - line[0][1] ;
    direction[1] = line[0][0] - line[1][0] ;
    c2v_normalize ( direction, direction ) ;
    RETURN ( c2t_mirror_dir ( origin, direction, t ) ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL* c2t_mirror_dir ( origin, direction, t ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT2 origin, direction ;
C2_TRANSFORM t ; 
{
    REAL dot ;

    dot = 2.0 * C2V_DOT ( origin, direction ) ;
    t[0][0] = 1.0 - 2.0 * direction[0] * direction[0] ;
    t[0][1] = - 2.0 * direction[0] * direction[1] ;
    t[0][2] = /* 2.0 * */ dot * direction[0] ;
    t[1][0] = t[0][1] ;
    t[1][1] = 1.0 - 2.0 * direction[1] * direction[1] ;
    t[1][2] = /* 2.0 * */ dot * direction[1] ;
    RETURN ( (REAL*)t ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL* c2t_lcs ( origin, x_axis, y_axis, t ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT2 origin, x_axis, y_axis ;
C2_TRANSFORM t ; 
{
    REAL d ;

    d = x_axis[0] * y_axis[1] - x_axis[1] * y_axis[0] ;
    if ( C2V_IS_SMALL(x_axis) || C2V_IS_SMALL(y_axis) || 
        fabs ( d ) <= BBS_ZERO * C2V_NORML1(x_axis) * C2V_NORML1(y_axis) )
        RETURN ( NULL ) ;
    t[0][0] = y_axis[1] / d ;
    t[0][1] = - y_axis[0] / d ;
    t[0][2] = ( y_axis[0] * origin[1] - y_axis[1] * origin[0] ) / d ;
    t[1][0] = - x_axis[1] / d ;
    t[1][1] = x_axis[0] / d ;
    t[1][2] = ( x_axis[1] * origin[0] - x_axis[0] * origin[1] ) / d ;
    RETURN ( (REAL*)t ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL* c2t_inverse ( t0, t1 ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C2_TRANSFORM t0, t1 ; 
{
    REAL det ;

    det = c2t_det ( t0 ) ;
    if ( IS_ZERO ( det ) ) 
        RETURN ( NULL ) ;
    t1[0][0] = t0[1][1] / det ;
    t1[0][1] = - t0[0][1] / det ;
    t1[1][0] = - t0[1][0] / det ;
    t1[1][1] = t0[0][0] / det ;
    t1[0][2] = - t1[0][0] * t0[0][2] - t1[0][1] * t0[1][2] ;
    t1[1][2] = - t1[1][0] * t0[0][2] - t1[1][1] * t0[1][2] ;
    RETURN ( (REAL*)t1 ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL c2t_det ( t ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C2_TRANSFORM t ; 
{
    RETURN ( t[0][0] * t[1][1] - t[0][1] * t[1][0] ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC BOOLEAN c2t_poly_xform ( poly0, poly1, m, i1, xform ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT2 *poly0, *poly1 ;
INT m, i1 ;
C2_TRANSFORM xform ; 
{
    REAL xx, xy, yy, x, y, ux, uy, vx, vy, u, v, a[3][3], b[3], t[3] ;
    INT j0, j1 ;

    xx = 0.0 ;
    xy = 0.0 ;
    yy = 0.0 ;
    ux = 0.0 ;
    uy = 0.0 ;
    vx = 0.0 ;
    vy = 0.0 ;
    x = 0.0 ;
    y = 0.0 ; 
    u = 0.0 ; 
    v = 0.0 ; 

    for ( j0 = 0 ; j0 < m ; j0++ ) 
    {
        xx += poly0[j0][0] * poly0[j0][0] ;
        xy += poly0[j0][0] * poly0[j0][1] ;
        yy += poly0[j0][1] * poly0[j0][1] ;
        x  += poly0[j0][0] ;
        y  += poly0[j0][1] ;
        u  += poly1[j0][0] ;
        v  += poly1[j0][1] ;
    }

    for ( j0 = 0, j1 = i1 ; j0 < m ; j0++ ) 
    {
        ux += poly0[j0][0] * poly1[j1][0] ;
        uy += poly0[j0][1] * poly1[j1][0] ;
        vx += poly0[j0][0] * poly1[j1][1] ;
        vy += poly0[j0][1] * poly1[j1][1] ;
        j1++ ;
        if ( j1 == m ) 
            j1 = 0 ;
    }

    a[0][0] = xx ;
    a[0][1] = xy ;
    a[0][2] = x ;
    a[1][0] = xy ;
    a[1][1] = yy ;
    a[1][2] = y ;
    a[2][0] = x ;
    a[2][1] = y ;
    a[2][2] = (REAL)m ;

    b[0] = ux ;
    b[1] = uy ;
    b[2] = u ;
    if ( !all_3_by_3_lin_sys ( a, b, t ) )
        RETURN ( FALSE ) ;
    xform[0][0] = t[0] ;
    xform[0][1] = t[1] ;
    xform[0][2] = t[2] ;

    a[0][0] = xx ;
    a[0][1] = xy ;
    a[0][2] = x ;
    a[1][0] = xy ;
    a[1][1] = yy ;
    a[1][2] = y ;
    a[2][0] = x ;
    a[2][1] = y ;
    a[2][2] = (REAL)m ;

    b[0] = vx ;
    b[1] = vy ;
    b[2] = v ;
    if ( !all_3_by_3_lin_sys ( a, b, t ) )
        RETURN ( FALSE ) ;
    xform[1][0] = t[0] ;
    xform[1][1] = t[1] ;
    xform[1][2] = t[2] ;
    RETURN ( TRUE ) ;
}
