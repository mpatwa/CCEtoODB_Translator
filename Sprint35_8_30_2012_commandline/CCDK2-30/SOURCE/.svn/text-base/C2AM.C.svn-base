/* -2 -3 */
/************************************ C2AM.C *******************************/
/***************** Arrays of two-dimensional homogeneous points ************/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                     All rights reserved                  !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
#include <bbsdefs.h>
#ifdef   SPLINE
#include <c2apriv.h>
#include <c2hdefs.h>
#include <c2tpriv.h>
#include <c2vmcrs.h>

/*-------------------------------------------------------------------------*/
BBS_PRIVATE BOOLEAN c2a_inters_lines ( a1, b1, a2, b2 )
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                   All rights reserved                    !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT2 a1, b1, a2, b2 ;
{
    PT2 v1, v2, v ;
    REAL cross, cross1, cross2 ;
    REAL t1, t2 ;
    REAL tol1, tol2 ;
    INT j ;

    C2V_SUB ( b1, a1, v1 ) ;
    C2V_SUB ( b2, a2, v2 ) ;
    C2V_SUB ( a2, a1, v ) ;
    tol1 = BBS_TOL / C2V_NORML1 ( v1 ) ;
    tol2 = BBS_TOL / C2V_NORML1 ( v2 ) ;
    cross = C2V_CROSS ( v1, v2 ) ;
    cross1 = C2V_CROSS ( v, v1 ) ;
    cross2 = C2V_CROSS ( v, v2 ) ;
    if ( IS_SMALL(cross) ) {
        if ( IS_SMALL(cross1) ) {
            j = fabs(v[0]) + fabs(v1[0]) + fabs(v2[0]) > 
                fabs(v[1]) + fabs(v1[1]) + fabs(v2[1]) ? 0 : 1 ; 
            t1 = v[j] / v1[j] ; /* Parameter of a2 wrt [a1,b1] */
            if ( - tol2 <= t1 && t1 <= 1.0 + tol2 ) 
                RETURN ( TRUE ) ;
            t2 = t1 + v2[j] / v1[j] ; /* Parameter of a2 wrt [a1,b1] */
            if ( - tol2 <= t2 && t2 <= 1.0 + tol2 ) 
                RETURN ( TRUE ) ;
            RETURN ( ( t1 <= tol2 && t2 >= 1.0 - tol2 ) || 
                     ( t2 <= tol2 && t1 >= 1.0 - tol2 ) ) ;
        }
        else 
            RETURN ( FALSE ) ;
    }
    else {
        t1 = cross2 / cross ;
        t2 = cross1 / cross ;
        RETURN ( ( - tol1 <= t1 ) && ( t1 <= 1.0 + tol1 ) && 
                 ( - tol2 <= t2 ) && ( t2 <= 1.0 + tol2 ) ) ;
    }
}   

/*-------------------------------------------------------------------------*/
BBS_PRIVATE void c2a_sub ( a, d, pt, b ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                   All rights reserved                    !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
HPT2 *a , *b  ;     /* Input and output array ; may coincide */
INT  d ;            /* Number of points */
PT2  pt ;           /* Point being subtracted */
{
    INT i ;

    for ( i=0 ; i<d ; i++ ) {
        b[i][0] = a[i][0] - pt[0] * a[i][2] ;
        b[i][1] = a[i][1] - pt[1] * a[i][2] ;
        b[i][2] = a[i][2] ;
    }
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE void c2a_pt_hpt ( a, d, b ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                   All rights reserved                    !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/

PT2 *a  ;       /* a[d] */
INT d ;
HPT2 *b  ;      /* b[d] */

{
    INT i ;

    for ( i=0 ; i<d ; i++ ) {
        C2V_COPY ( a[i], b[i] ) ;
        b[i][2] = 1.0 ;
    }
}


#ifdef NEW_CODE
/*-------------------------------------------------------------------------*/
BOOLEAN c2a_hpt_pt ( b, d, a ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                   All rights reserved                    !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
HPT2 *b  ;      /* b[d] */
INT d ;
PT2 *a  ;       /* a[d] */
{
    INT i ;

    for ( i=0 ; i<d ; i++ ) {
        if ( IS_SMALL(b[i][2]) )
            RETURN ( FALSE ) ;
        a[i][0] = b[i][0]/b[i][2] ;
        a[i][1] = b[i][1]/b[i][2] ;
    }
    RETURN ( TRUE ) ;
}


/*-------------------------------------------------------------------------*/
void c2a_rotate_pt_cs ( a0, n, origin, c, s, a1 ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989 - 1995 Building Block Software!!!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT2    *a0, *a1 ;
INT     n ;
PT2     origin ;
REAL    c, s ;
{
    INT i ;
    PT2 vec ;

    for ( i=0 ; i<n ; i++ ) {
        C2V_SUB ( a0[i], origin, vec ) ;
        C2V_ROTATE_VEC_CS( vec, c, s, a1[i] ) ;
        C2V_ADD ( a1[i], origin, a1[i] ) ;
    }
}
#endif /*NEW_CODE*/

/*-------------------------------------------------------------------------*/
BBS_PRIVATE void c2a_rotate_hpt_cs ( a0, n, origin, c, s, a1 ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989 - 1995 Building Block Software!!!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
HPT2    *a0, *a1 ;
INT     n ;
PT2     origin ;
REAL    c, s ;
{
    INT i ;
    PT2 vec ;

    for ( i=0 ; i<n ; i++ ) {
        vec[0] = a0[i][0] - origin[0] * a0[i][2] ;
        vec[1] = a0[i][1] - origin[1] * a0[i][2] ;
        C2V_ROTATE_VEC_CS ( vec, c, s, a1[i] ) ;
        a1[i][0] += origin[0] * a0[i][2] ;
        a1[i][1] += origin[1] * a0[i][2] ;
        a1[i][2] = a0[i][2] ;
    }
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE void c2a_mirror_hpt ( a0, n, origin, normal, a1 ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
HPT2    *a0, *a1 ;
INT     n ;
PT2     origin, normal ;
{
    INT i ;

    for ( i=0 ; i<n ; i++ ) 
        c2h_mirror ( a0[i], origin, normal, a1[i] ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE BOOLEAN c2a_offset ( a, p, q, w, b ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT2 a, p, q, b ;
REAL w ;
{
    REAL cross ;

    if ( p==NULL ) {
        b[0] = a[0] + w * q[1] ;
        b[1] = a[1] - w * q[0] ;
    }

    else if ( q==NULL ) {
        b[0] = a[0] + w * p[1] ;
        b[1] = a[1] - w * p[0] ;
    }

    else {
        cross = C2V_CROSS ( p, q ) ;

        if ( IS_ZERO ( cross ) ) {
            if ( C2V_DOT ( p, q ) < 0.0 ) 
                RETURN ( FALSE ) ;
            b[0] = a[0] + w * p[1] ;
            b[1] = a[1] - w * p[0] ;
        }
        else {
            w /= cross ;
            b[0] = a[0] + w * ( p[0] - q[0] ) ;
            b[1] = a[1] + w * ( p[1] - q[1] ) ;
        }
    }
    RETURN ( TRUE ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE void c2a_transform_hpt ( a, n, t, b ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
HPT2    *a ;
INT     n ;
C2_TRANSFORM t ;
HPT2    *b ;
{
    INT i ;
    for ( i=0 ; i<n ; i++ ) 
        c2t_eval_hpt ( a[i], t, b[i] ) ;
}
#endif   /*SPLINE*/

