/* -2 -3 */
/*********************************** C2BV.C ********************************/
/*********************** Two-dimensional Bezier curves *********************/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/

#include <bbsdefs.h>
#ifdef  SPLINE
#include <aladefs.h>
#include <c2bdefs.h>
#include <c2hdefs.h>
#include <c2vmcrs.h>
#include <c2coned.h>

/*-------------------------------------------------------------------------*/
BBS_PRIVATE void c2b_dot ( b1, d1, b2, d2, b ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/

HPT2 *b1 , *b2  ;
HREAL *b  ;
INT d1, d2 ;
{
    INT i, j, k, d=d1+d2-1 ;
    REAL w, *c, *c1, *c2, *c0 ;

    c = CREATE ( d*d, REAL ) ;
    ala_binom ( d, c ) ;
    c1 = c + d * (d1-1) ;
    c2 = c + d * (d2-1) ;
    c0 = c + d * (d-1) ;

    for ( k=0 ; k<d ; k++ ) {
        b[k][0] = 0.0 ;
        b[k][1] = 0.0 ;
    }
    
    for ( i=0 ; i<d1 ; i++ )
        for ( j=0 ; j<d2 ; j++ ) {
            w = c1[i] * c2[j] ;
            b[i+j][0] += ( w * C2V_DOT ( b1[i], b2[j] ) ) ;
            b[i+j][1] += ( w * b1[i][2] * b2[j][2] ) ;
        }
    for ( k=0 ; k<d ; k++ ) {
        b[k][0] /= (c0[k]) ;
        b[k][1] /= (c0[k]) ;
    }
    KILL ( c ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE void c2b_cross ( b1, d1, b2, d2, b ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/

HPT2 *b1 , *b2  ;
HREAL *b  ;
INT d1, d2 ;
{
    INT i, j, k, d=d1+d2-1 ;
    REAL w, *c, *c1, *c2, *c0 ;

    c = CREATE ( d*d, REAL ) ;
    ala_binom ( d, c ) ;
    c1 = c + d * (d1-1) ;
    c2 = c + d * (d2-1) ;
    c0 = c + d * (d-1) ;

    for ( k=0 ; k<d ; k++ ) {
        b[k][0] = 0.0 ;
        b[k][1] = 0.0 ;
    }
    
    for ( i=0 ; i<d1 ; i++ )
        for ( j=0 ; j<d2 ; j++ ) {
            w = c1[i] * c2[j] ;
            b[i+j][0] += ( w * C2V_CROSS ( b1[i], b2[j] ) ) ;
            b[i+j][1] += ( w * b1[i][2] * b2[j][2] ) ;
        }
    for ( k=0 ; k<d ; k++ ) {
        b[k][0] /= (c0[k]) ;
        b[k][1] /= (c0[k]) ;
    }
    KILL ( c ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE void c2b_dot_nonrat ( b1, d1, b2, d2, b ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/

PT2 *b1 , *b2  ;
REAL *b  ;
INT d1, d2 ;
{
    INT i, j, k, d=d1+d2-1 ;
    REAL *c, *c1, *c2, *c0 ;

    c = CREATE ( d*d, REAL ) ;
    ala_binom ( d, c ) ;
    c1 = c + d * (d1-1) ;
    c2 = c + d * (d2-1) ;
    c0 = c + d * (d-1) ;

    for ( k=0 ; k<d ; k++ ) 
        b[k] = 0.0 ;
    
    for ( i=0 ; i<d1 ; i++ )
        for ( j=0 ; j<d2 ; j++ ) 
            b[i+j] += ( c1[i] * c2[j] * C2V_DOT ( b1[i], b2[j] ) ) ;

    for ( k=0 ; k<d ; k++ ) 
        b[k] /= (c0[k]) ;
    KILL ( c ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE void c2b_deriv ( a, d, b ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/

/* b = a'* w - a * w' ; ord(b) = 2*d-3 */

HPT2 *a  ;
INT d ;
PT2 *b  ;
{
    INT i, k, d1=2*d-3 ;
    REAL w, *c, *c1, *c0 ;
    
    c = CREATE ( d1*d1, REAL ) ;
    ala_binom ( d1, c ) ;
    c0 = c + d1 * (d-1) ;
    c1 = c + d1 * (d1-1) ;

    for ( k=0 ; k<d1 ; k++ ) {
        b[k][0] = 0.0 ;
        b[k][1] = 0.0 ;
    }

    for ( i=1 ; i<d ; i++ ) 
        for ( k=0 ; k<i ; k++ ) {
            w = (REAL)(i-k) * c0[i] * c0[k] ;
            b[i+k-1][0] += ( w * ( a[i][0]*a[k][2] - a[k][0]*a[i][2] ) ) ;
            b[i+k-1][1] += ( w * ( a[i][1]*a[k][2] - a[k][1]*a[i][2] ) ) ;
        }    
    for ( k=0 ; k<d1 ; k++ ) {
        b[k][0] /= (c1[k]) ;
        b[k][1] /= (c1[k]) ;
    }
    KILL ( c ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE void c2b_cross_deriv ( a, d, b ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/

/* b = a x a' ; ord(b) = 2*d-3 */

PT2 *a  ;
INT d ;
REAL *b  ;
{
    INT i, k, d1=2*d-3 ;
    REAL *c, *c1, *c0 ;
    
    c = CREATE ( d1*d1, REAL ) ;
    ala_binom ( d1, c ) ;
    c0 = c + d1 * (d-1) ;
    c1 = c + d1 * (d1-1) ;

    for ( k=0 ; k<d1 ; k++ ) 
        b[k] = 0.0 ;

    for ( i=1 ; i<d ; i++ ) 
        for ( k=0 ; k<i ; k++ ) 
            b[i+k-1] += ( (REAL)(i-k) * c0[i] * c0[k] * 
                        C2V_CROSS ( a[k], a[i] ) ) ;

    for ( k=0 ; k<d1 ; k++ ) 
        b[k] /= (c1[k]) ;
    KILL ( c ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE INT c2b_coinc ( b1, d1, w1, b2, d2, w2 ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
HPT2    *b1 ;  /* Control points of the first segment */
INT     d1 ;    /* Order of the first segment */
REAL    w1 ;    /* Offset of the first segment */
HPT2    *b2 ;  /* Control points of the second segment */
INT     d2 ;    /* Order of the second segment */
REAL    w2 ;    /* Offset of the second segment */
{
    INT i, dir ;

    if ( ( d1 != d2 ) || !IS_SMALL(w1-w2) )
        RETURN ( 0 ) ;
    dir = 0 ;

    for ( i = 0 ; i < d1 ; i++ ) {
        if ( dir == 0 ) {
            if ( c2h_ident_pts ( b1[i], b2[i] ) )
                dir = 1 ;
            else if ( c2h_ident_pts ( b1[i], b2[d1-i-1] ) )
                dir = -1 ;
            else 
                RETURN ( 0 ) ;
        }
        else if ( dir == 1 ) {
            if ( !c2h_ident_pts ( b1[i], b2[i] ) )
                RETURN ( 0 ) ;
        }
        else if ( dir == -1 ) {
            if ( !c2h_ident_pts ( b1[i], b2[d1-i-1] ) )
                RETURN ( 0 ) ;
        }
    }
    RETURN ( dir ) ;
}

#endif  /*SPLINE*/

