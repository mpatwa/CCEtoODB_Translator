/* -2 -3 */
/********************************** C2L.C **********************************/
/******************** Routines for processing lines ************************/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
#include <c2ldefs.h>
#include <c2vdefs.h>
#include <c2mem.h>
#include <c2lmcrs.h>
#include <c2vmcrs.h>
#include <dmbdefs.h>
GLOBAL      INT             C2_LINE_BUF_SIZE=0 ;
GLOBAL      INT             C2_LINES_NUMBER=0 ;
GLOBAL      C2_LINE         *C2_LINE_BUFFER ;

/*----------------------------------------------------------------------*/
BBS_PRIVATE void c2l_set_buf_size ( n ) 
/*----------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                      !!!!!!!!*/
/*!!!!!!!!     (C) Copyright 1989 - 1995 Building Block Software!!!!!!!!*/
/*!!!!!!!!                   All rights reserved                !!!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
INT n ;
{
    C2_LINE_BUF_SIZE = n ;
}


/*----------------------------------------------------------------------*/
BBS_PRIVATE C2_LINE c2l_alloc () 
/*----------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                      !!!!!!!!*/
/*!!!!!!!!     (C) Copyright 1989 - 1995 Building Block Software!!!!!!!!*/
/*!!!!!!!!                   All rights reserved                !!!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
{
    RETURN ( (C2_LINE)dmb_malloc ( (ANY**)&C2_LINE_BUFFER, C2_LINE_BUF_SIZE, 
        &C2_LINES_NUMBER, sizeof(C2_LINE_S) ) ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE void c2l_free ( line )
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C2_LINE line ;     /* Line to be freed, can be NULL */
{
    dmb_free ( line, (ANY**)&C2_LINE_BUFFER, C2_LINE_BUF_SIZE, 
        &C2_LINES_NUMBER, PF_NULL ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE C2_LINE c2l_create_copy ( line0 ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C2_LINE line0 ;
{
    C2_LINE line = c2l_alloc() ;
    if ( line != NULL ) 
        c2l_copy ( line0, line ) ;
    RETURN ( line ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE void c2l_copy ( line0, line ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/

C2_LINE line0, line ;
{
    C2V_COPY ( C2_LINE_PT0(line0), C2_LINE_PT0(line) ) ;
    C2V_COPY ( C2_LINE_PT1(line0), C2_LINE_PT1(line) ) ;
}


/*----------------------------------------------------------------------*/
BBS_PRIVATE C2_LINE c2l_create_2pts ( ept0, ept1 ) 
/*----------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                      !!!!!!!!*/
/*!!!!!!!! (C) Copyright 1989 - 1995 Building Block Software !!!!!!!*/
/*!!!!!!!!                   All rights reserved                !!!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT2 ept0, ept1 ;
{
    C2_LINE line ;

    line = c2l_alloc() ;
    if ( line != NULL ) 
        c2l_2pts ( ept0, ept1, line ) ;
    RETURN ( line ) ;
}


/*----------------------------------------------------------------------*/
BBS_PRIVATE void c2l_2pts ( ept0, ept1, line ) 
/*----------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                      !!!!!!!!*/
/*!!!!!!!!     (C) Copyright 1989 - 1995 Building Block Software!!!!!!!!*/
/*!!!!!!!!                   All rights reserved                !!!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C2_LINE line ;
PT2 ept0, ept1 ;
{
    C2V_COPY ( ept0, C2_LINE_PT0(line) ) ;
    C2V_COPY ( ept1, C2_LINE_PT1(line) ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE void c2l_eval ( line, t, p, x ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C2_LINE line ;
REAL t ;
INT p ;
PT2 *x ;
{
    INT i ;

    if ( p<0 ) 
        RETURN ; 
    C2V_ADDU ( C2_LINE_PT0(line), C2_LINE_PT1(line), t, x[0] ) ;
    if ( p<1 ) 
        RETURN ; 
    C2_LINE_DIR_VEC ( line, x[1] ) ;
    if ( p<2 ) 
        RETURN ; 
    for ( i=2; i<=p ; i++ )
        C2V_SET_ZERO ( x[i] ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE void c2l_pt_tan ( line, t, pt, tan_vec ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C2_LINE line ;
REAL t ;
PT2 pt, tan_vec ;
{
    if ( pt != NULL ) 
        C2V_ADDU ( C2_LINE_PT0(line), C2_LINE_PT1(line), t, pt ) ;
    if ( tan_vec != NULL ) 
        C2_LINE_DIR_VEC ( line, tan_vec ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE REAL c2l_project ( line, pt, proj_pt ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/

C2_LINE line ;
PT2 pt, proj_pt ;
{
    PT2 dir_vec, pr_vec ;
    REAL t ;

    C2V_SUB ( pt, C2_LINE_PT0(line), pr_vec ) ;
    C2_LINE_DIR_VEC ( line, dir_vec ) ;
    if ( C2V_IS_SMALL(dir_vec) ) 
        t = 0.0 ;
    else 
        t = C2V_DOT ( pr_vec, dir_vec ) / C2V_DOT ( dir_vec, dir_vec ) ; 
    if ( proj_pt != NULL ) 
        C2V_ADDT ( C2_LINE_PT0(line), dir_vec, t, proj_pt ) ;
    RETURN ( t ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE void c2l_offset ( line0, w, line ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/

C2_LINE line0, line ;
REAL w ;
{
    PT2 dir_vec ;

    C2_LINE_DIR_VEC ( line0, dir_vec ) ;
    (void) c2v_normalize ( dir_vec, dir_vec ) ;
    C2V_OFFSET ( C2_LINE_PT0(line0), dir_vec, w, C2_LINE_PT0(line) ) ;
    C2V_OFFSET ( C2_LINE_PT1(line0), dir_vec, w, C2_LINE_PT1(line) ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE REAL c2l_length ( line, t0, t1 ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C2_LINE line ;
REAL t0, t1 ;
{
    PT2 dir_vec ;

    C2_LINE_DIR_VEC ( line, dir_vec ) ;
    RETURN ( ( t1 - t0 ) * C2V_NORM ( dir_vec ) ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE C2_LINE c2l_reverse ( line0, line1 ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C2_LINE line0, line1 ;
{
    PT2 p ;
    C2V_COPY ( C2_LINE_PT0(line0), p ) ;
    C2V_COPY ( C2_LINE_PT1(line0), C2_LINE_PT0(line1) ) ;
    C2V_COPY ( p, C2_LINE_PT1(line1) ) ;
    RETURN ( line1 ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE BOOLEAN c2l_get_pts_d ( line, t0, t1, pt0, pt1, d_ptr ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!      (C) Copyright 1989 - 1995 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C2_LINE line ;
REAL t0, t1 ;
PT2 pt0, pt1 ;
REAL* d_ptr ;
{
    C2V_ADDU ( C2_LINE_PT0(line), C2_LINE_PT1(line), t0, pt0 ) ;
    C2V_ADDU ( C2_LINE_PT0(line), C2_LINE_PT1(line), t1, pt1 ) ;
    *d_ptr = 0.0 ;
    RETURN ( TRUE ) ;
}

